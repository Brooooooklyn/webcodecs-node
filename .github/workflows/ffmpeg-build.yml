name: Build FFmpeg Static

on:
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version tag (e.g., n8.0.1)'
        required: true
        default: 'n8.0.1'

env:
  FFMPEG_VERSION: ${{ github.event.inputs.ffmpeg_version || 'n8.0.1' }}

jobs:
  # Build for x86_64 and aarch64 targets using zig
  build-ffmpeg:
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-musl

    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Setup nasm
        uses: ilammy/setup-nasm@v1

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake git nasm yasm pkg-config \
            autoconf automake libtool curl

      - name: Build FFmpeg
        run: |
          cargo build --release -p build-ffmpeg
          ./target/release/build-ffmpeg \
            --target ${{ matrix.target }} \
            --output ./ffmpeg-${{ matrix.target }} \
            --verbose

      - name: Create tarball
        run: |
          tar -czvf ffmpeg-${{ matrix.target }}.tar.gz \
            -C ./ffmpeg-${{ matrix.target }} .

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ffmpeg-${{ matrix.target }}.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.target }}
          path: ffmpeg-${{ matrix.target }}.tar.gz
          if-no-files-found: error

  # Build Windows arm64 using vcpkg (libaom for AV1)
  build-ffmpeg-windows-arm64:
    name: Build aarch64-pc-windows-msvc
    runs-on: windows-latest
    permissions:
      id-token: write
      attestations: write
      contents: read

    env:
      VCPKG_DEFAULT_TRIPLET: arm64-windows-static

    steps:
      - uses: actions/checkout@v4

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '74e6536215718009aae747d86d84b78376bf9e09'

      - name: Install FFmpeg with codecs via vcpkg
        # Note: vcpkg's FFmpeg port doesn't support jxl feature
        # libjxl would require building FFmpeg from source like we do for x64
        run: |
          vcpkg install ffmpeg[avformat,avcodec,swresample,swscale,gpl,x264,x265,vpx,aom,opus,mp3lame,vorbis,webp,zlib]:arm64-windows-static

      - name: List vcpkg installed libraries
        run: |
          Write-Host "=== All installed .lib files in vcpkg ==="
          Get-ChildItem "$env:VCPKG_ROOT/installed/arm64-windows-static/lib/*.lib" | ForEach-Object { $_.Name }

      - name: Prepare output directory
        run: |
          $prefix = "ffmpeg-aarch64-pc-windows-msvc"
          New-Item -ItemType Directory -Force -Path "$prefix/lib"
          New-Item -ItemType Directory -Force -Path "$prefix/include"

          # Copy libraries
          Copy-Item -Path "$env:VCPKG_ROOT/installed/arm64-windows-static/lib/*.lib" -Destination "$prefix/lib/" -Force

          # Copy headers
          Copy-Item -Path "$env:VCPKG_ROOT/installed/arm64-windows-static/include/libav*" -Destination "$prefix/include/" -Recurse -Force
          Copy-Item -Path "$env:VCPKG_ROOT/installed/arm64-windows-static/include/libsw*" -Destination "$prefix/include/" -Recurse -Force

          # Copy codec headers if present
          $codecHeaders = @("x264.h", "x264_config.h", "x265.h", "x265_config.h", "vpx", "aom", "opus", "lame", "vorbis", "ogg", "webp")
          foreach ($header in $codecHeaders) {
            $srcPath = "$env:VCPKG_ROOT/installed/arm64-windows-static/include/$header"
            if (Test-Path $srcPath) {
              Copy-Item -Path $srcPath -Destination "$prefix/include/" -Recurse -Force
            }
          }

          # List output
          Write-Host "=== Libraries ==="
          Get-ChildItem "$prefix/lib/"
          Write-Host "=== Headers ==="
          Get-ChildItem "$prefix/include/" -Recurse

      - name: Create archive
        run: |
          Compress-Archive -Path "ffmpeg-aarch64-pc-windows-msvc/*" -DestinationPath "ffmpeg-aarch64-pc-windows-msvc.zip"

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ffmpeg-aarch64-pc-windows-msvc.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-aarch64-pc-windows-msvc
          path: ffmpeg-aarch64-pc-windows-msvc.zip
          if-no-files-found: error

  # Build Windows x64 from source with rav1e (libaom crashes on Windows MSVC)
  build-ffmpeg-windows-x64:
    name: Build x86_64-pc-windows-msvc
    runs-on: windows-latest
    permissions:
      id-token: write
      attestations: write
      contents: read

    env:
      VCPKG_DEFAULT_TRIPLET: x64-windows-static
      RAV1E_VERSION: '0.8.1'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Visual Studio environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MSYS
          update: true
          path-type: inherit
          install: >-
            make
            diffutils
            pkg-config

      - name: Setup NASM
        uses: ilammy/setup-nasm@v1

      - name: Download rav1e prebuilt
        shell: pwsh
        run: |
          $RAV1E_VERSION = "${{ env.RAV1E_VERSION }}"
          $url = "https://github.com/xiph/rav1e/releases/download/v$RAV1E_VERSION/rav1e-$RAV1E_VERSION-windows-msvc-generic.zip"
          Invoke-WebRequest -Uri $url -OutFile rav1e.zip
          Expand-Archive -Path rav1e.zip -DestinationPath rav1e-extracted
          # rav1e extracts to rav1e-windows-msvc-sdk/
          Move-Item "rav1e-extracted/rav1e-windows-msvc-sdk" rav1e-dist
          Write-Host "=== rav1e contents ==="
          Get-ChildItem rav1e-dist -Recurse

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '74e6536215718009aae747d86d84b78376bf9e09'

      - name: Install codec dependencies (without FFmpeg)
        run: |
          vcpkg install `
            x264:x64-windows-static `
            x265:x64-windows-static `
            libvpx:x64-windows-static `
            dav1d:x64-windows-static `
            opus:x64-windows-static `
            mp3lame:x64-windows-static `
            libogg:x64-windows-static `
            libvorbis:x64-windows-static `
            libwebp:x64-windows-static `
            zlib:x64-windows-static `
            libjxl:x64-windows-static

      - name: List vcpkg installed libraries
        run: |
          Write-Host "=== All installed .lib files in vcpkg ==="
          Get-ChildItem "$env:VCPKG_ROOT/installed/x64-windows-static/lib/*.lib" | ForEach-Object { $_.Name }

      - name: Clone FFmpeg
        run: |
          git clone --depth=1 -b ${{ env.FFMPEG_VERSION }} https://github.com/FFmpeg/FFmpeg.git ffmpeg-src

      - name: Build FFmpeg with MSVC toolchain
        shell: msys2 {0}
        run: |
          # Add NASM to PATH for assembly optimizations (x264, x265, vpx benefit from this)
          # NASM is installed via ilammy/setup-nasm@v1 to C:/Program Files/NASM
          NASM_PATH="/c/Program Files/NASM"
          if [ -d "$NASM_PATH" ]; then
            export PATH="$PATH:$NASM_PATH"
            echo "=== NASM version ==="
            nasm --version || echo "NASM not functional"
          else
            echo "WARNING: NASM directory not found at $NASM_PATH, assembly optimizations may be disabled"
          fi

          # Convert paths to Windows mixed-style (D:/a/...) for MSVC compatibility
          # Use cygpath -m for Windows-style paths that work with both MSYS2 tools and MSVC
          VCPKG_ROOT_WIN=$(cygpath -m "$VCPKG_ROOT")
          VCPKG_INSTALLED="$VCPKG_ROOT_WIN/installed/x64-windows-static"
          RAV1E_DIR=$(cygpath -m "$(pwd)/rav1e-dist")
          PREFIX=$(cygpath -m "$(pwd)/ffmpeg-x86_64-pc-windows-msvc")

          # MSYS-style paths for shell operations
          VCPKG_ROOT_MSYS=$(cygpath "$VCPKG_ROOT")
          VCPKG_INSTALLED_MSYS="$VCPKG_ROOT_MSYS/installed/x64-windows-static"
          RAV1E_DIR_MSYS=$(cygpath "$(pwd)/rav1e-dist")

          # Create pkg-config directory
          PKGCONFIG_DIR=$(cygpath -m "$(pwd)/pkgconfig")
          PKGCONFIG_DIR_MSYS=$(pwd)/pkgconfig
          mkdir -p "$PKGCONFIG_DIR_MSYS"

          echo "=== Path debug ==="
          echo "VCPKG_INSTALLED (Windows): $VCPKG_INSTALLED"
          echo "VCPKG_INSTALLED (MSYS): $VCPKG_INSTALLED_MSYS"
          echo "RAV1E_DIR (Windows): $RAV1E_DIR"
          echo "PKGCONFIG_DIR (Windows): $PKGCONFIG_DIR"

          # List actual library files to verify names
          echo "=== vcpkg lib files ==="
          ls -la "$VCPKG_INSTALLED_MSYS/lib/"*.lib 2>/dev/null | head -30 || echo "No .lib files found"

          echo "=== rav1e lib files ==="
          ls -la "$RAV1E_DIR_MSYS/lib/"* 2>/dev/null || echo "No rav1e lib files found"

          # Create pkg-config files with proper Libs for configure checks
          # We create library symlinks so FFmpeg can find libs with expected names
          # (vcpkg uses different names: libx264.lib vs x264.lib, etc.)

          # Helper function to create pkg-config files with Libs
          create_pc() {
            local file="$1" prefix="$2" name="$3" desc="$4" version="$5" cflags="$6" libs="$7"
            {
              printf 'prefix=%s\n' "$prefix"
              printf 'libdir=${prefix}/lib\n'
              printf 'includedir=${prefix}/include\n'
              printf '\n'
              printf 'Name: %s\n' "$name"
              printf 'Description: %s\n' "$desc"
              printf 'Version: %s\n' "$version"
              printf 'Libs: -L${libdir} %s\n' "$libs"
              printf 'Cflags: %s\n' "$cflags"
            } > "$file"
          }

          # rav1e (needs system libs for Rust runtime)
          create_pc "$PKGCONFIG_DIR_MSYS/rav1e.pc" "$RAV1E_DIR" "rav1e" "rav1e AV1 encoder" "0.8.1" '-I${includedir}/rav1e' '-lrav1e -lws2_32 -luserenv -lntdll -lbcrypt'

          # x264
          create_pc "$PKGCONFIG_DIR_MSYS/x264.pc" "$VCPKG_INSTALLED" "x264" "x264 H.264 encoder" "0.164" '-I${includedir}' '-lx264'

          # x265
          create_pc "$PKGCONFIG_DIR_MSYS/x265.pc" "$VCPKG_INSTALLED" "x265" "x265 HEVC encoder" "3.5" '-I${includedir}' '-lx265'

          # vpx
          create_pc "$PKGCONFIG_DIR_MSYS/vpx.pc" "$VCPKG_INSTALLED" "vpx" "WebM VP8/VP9 codec" "1.13.0" '-I${includedir}' '-lvpx'

          # opus
          create_pc "$PKGCONFIG_DIR_MSYS/opus.pc" "$VCPKG_INSTALLED" "opus" "Opus audio codec" "1.4" '-I${includedir}/opus' '-lopus'

          # libmp3lame (needs mpghip for MP3 decoding interface)
          create_pc "$PKGCONFIG_DIR_MSYS/libmp3lame.pc" "$VCPKG_INSTALLED" "libmp3lame" "LAME MP3 encoder" "3.100" '-I${includedir}' '-lmp3lame -lmpghip'

          # ogg
          create_pc "$PKGCONFIG_DIR_MSYS/ogg.pc" "$VCPKG_INSTALLED" "ogg" "Ogg bitstream library" "1.3.5" '-I${includedir}' '-logg'

          # vorbis (depends on ogg)
          create_pc "$PKGCONFIG_DIR_MSYS/vorbis.pc" "$VCPKG_INSTALLED" "vorbis" "Vorbis audio codec" "1.3.7" '-I${includedir}' '-lvorbis -logg'

          # vorbisenc (depends on vorbis)
          create_pc "$PKGCONFIG_DIR_MSYS/vorbisenc.pc" "$VCPKG_INSTALLED" "vorbisenc" "Vorbis encoder" "1.3.7" '-I${includedir}' '-lvorbisenc -lvorbis -logg'

          # vorbisfile (depends on vorbis)
          create_pc "$PKGCONFIG_DIR_MSYS/vorbisfile.pc" "$VCPKG_INSTALLED" "vorbisfile" "Vorbis file decoder" "1.3.7" '-I${includedir}' '-lvorbisfile -lvorbis -logg'

          # libwebp (needs sharpyuv)
          create_pc "$PKGCONFIG_DIR_MSYS/libwebp.pc" "$VCPKG_INSTALLED" "libwebp" "WebP image codec" "1.3.2" '-I${includedir}' '-lwebp -lsharpyuv'

          # zlib
          create_pc "$PKGCONFIG_DIR_MSYS/zlib.pc" "$VCPKG_INSTALLED" "zlib" "zlib compression library" "1.3" '-I${includedir}' '-lz'

          # dav1d AV1 decoder
          create_pc "$PKGCONFIG_DIR_MSYS/dav1d.pc" "$VCPKG_INSTALLED" "dav1d" "dav1d AV1 decoder" "1.5.1" '-I${includedir}' '-ldav1d'

          # libjxl JPEG XL (needs brotli, highway, lcms2)
          create_pc "$PKGCONFIG_DIR_MSYS/libjxl.pc" "$VCPKG_INSTALLED" "libjxl" "JPEG XL image codec" "0.11.1" '-I${includedir}' '-ljxl -ljxl_threads -lhwy -lbrotlidec -lbrotlienc -lbrotlicommon -llcms2'
          create_pc "$PKGCONFIG_DIR_MSYS/libjxl_threads.pc" "$VCPKG_INSTALLED" "libjxl_threads" "JPEG XL threading" "0.11.1" '-I${includedir}' '-ljxl_threads'

          # Set up pkg-config path (use MSYS path for pkg-config tool)
          export PKG_CONFIG_PATH="$PKGCONFIG_DIR_MSYS"

          # Create library copies with names FFmpeg's configure expects
          # FFmpeg's check_lib uses -lmp3lame which becomes mp3lame.lib,
          # but vcpkg provides libmp3lame-static.lib
          echo "=== Creating library copies for FFmpeg configure checks ==="
          cd "$VCPKG_INSTALLED_MSYS/lib"
          # mp3lame: libmp3lame-static.lib -> mp3lame.lib
          [ -f libmp3lame-static.lib ] && [ ! -f mp3lame.lib ] && cp libmp3lame-static.lib mp3lame.lib && echo "Created mp3lame.lib"
          # mpghip: libmpghip-static.lib -> mpghip.lib (required by mp3lame for MP3 decoding)
          [ -f libmpghip-static.lib ] && [ ! -f mpghip.lib ] && cp libmpghip-static.lib mpghip.lib && echo "Created mpghip.lib"
          # x264: libx264.lib -> x264.lib
          [ -f libx264.lib ] && [ ! -f x264.lib ] && cp libx264.lib x264.lib && echo "Created x264.lib"
          # x265: x265-static.lib -> x265.lib
          [ -f x265-static.lib ] && [ ! -f x265.lib ] && cp x265-static.lib x265.lib && echo "Created x265.lib"
          # webp: libwebp.lib -> webp.lib
          [ -f libwebp.lib ] && [ ! -f webp.lib ] && cp libwebp.lib webp.lib && echo "Created webp.lib"
          # sharpyuv: libsharpyuv.lib -> sharpyuv.lib
          [ -f libsharpyuv.lib ] && [ ! -f sharpyuv.lib ] && cp libsharpyuv.lib sharpyuv.lib && echo "Created sharpyuv.lib"
          # zlib: zlib.lib -> z.lib (for -lz)
          [ -f zlib.lib ] && [ ! -f z.lib ] && cp zlib.lib z.lib && echo "Created z.lib"
          ls -la *.lib | head -30
          cd -

          # Debug: show pkg-config file content and test
          echo "=== libmp3lame.pc content ==="
          cat "$PKGCONFIG_DIR_MSYS/libmp3lame.pc"
          echo ""
          echo "=== Testing pkg-config ==="
          pkg-config --exists x264 && echo "x264: found" || echo "x264: not found"
          pkg-config --exists x265 && echo "x265: found" || echo "x265: not found"
          pkg-config --exists vpx && echo "vpx: found" || echo "vpx: not found"
          pkg-config --exists rav1e && echo "rav1e: found" || echo "rav1e: not found"
          pkg-config --exists dav1d && echo "dav1d: found" || echo "dav1d: not found"
          pkg-config --exists opus && echo "opus: found" || echo "opus: not found"
          pkg-config --exists libmp3lame && echo "libmp3lame: found" || echo "libmp3lame: not found"

          echo "=== pkg-config --libs libmp3lame ==="
          pkg-config --libs libmp3lame || echo "Failed to get libs"

          echo "=== pkg-config --cflags libmp3lame ==="
          pkg-config --cflags libmp3lame || echo "Failed to get cflags"

          cd ffmpeg-src

          # Configure FFmpeg with MSVC toolchain (aligned with vcpkg approach)
          # Key vcpkg-aligned settings:
          # - --disable-inline-asm: prevents undefined symbol issues on MSVC
          # - --enable-w32threads: Windows native threading
          # - --enable-pic: position-independent code
          # - --enable-runtime-cpudetect: runtime CPU feature detection
          # - --extra-libs: bypass pkg-config library name mapping issues
          #   (vcpkg uses libx264.lib, FFmpeg expects x264.lib, etc.)
          ./configure \
            --prefix="$PREFIX" \
            --toolchain=msvc \
            --arch=x86_64 \
            --disable-inline-asm \
            --enable-w32threads \
            --enable-pic \
            --enable-runtime-cpudetect \
            --enable-static \
            --disable-shared \
            --enable-gpl \
            --enable-version3 \
            --disable-autodetect \
            --enable-avcodec \
            --enable-swscale \
            --enable-swresample \
            --enable-avformat \
            --disable-avfilter \
            --disable-avdevice \
            --disable-network \
            --disable-programs \
            --disable-doc \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libvpx \
            --enable-librav1e \
            --enable-libdav1d \
            --enable-libopus \
            --enable-libmp3lame \
            --enable-libvorbis \
            --enable-libwebp \
            --enable-libjxl \
            --enable-zlib \
            --extra-cflags="-I$VCPKG_INSTALLED/include -I$RAV1E_DIR/include -I$RAV1E_DIR/include/rav1e" \
            --extra-ldflags="-libpath:$VCPKG_INSTALLED/lib -libpath:$RAV1E_DIR/lib" \
            --extra-libs="libx264.lib x265-static.lib vpx.lib rav1e.lib dav1d.lib opus.lib libmp3lame-static.lib libmpghip-static.lib vorbis.lib vorbisenc.lib ogg.lib libwebp.lib libsharpyuv.lib jxl.lib jxl_threads.lib hwy.lib brotlidec.lib brotlienc.lib brotlicommon.lib lcms2.lib zlib.lib ws2_32.lib userenv.lib ntdll.lib bcrypt.lib" \
            --pkg-config-flags="--static"

          make -j$(nproc)
          make install

      - name: Upload FFmpeg config.log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-config-log-x64
          path: ffmpeg-src/ffbuild/config.log
          if-no-files-found: ignore

      - name: Copy rav1e and codec libs to output
        shell: pwsh
        run: |
          $prefix = "ffmpeg-x86_64-pc-windows-msvc"

          # Copy rav1e
          Copy-Item "rav1e-dist/lib/rav1e.lib" -Destination "$prefix/lib/" -Force
          New-Item -ItemType Directory -Force -Path "$prefix/include/rav1e"
          Copy-Item "rav1e-dist/include/rav1e/*" -Destination "$prefix/include/rav1e/" -Force

          # Copy vcpkg codec libs that FFmpeg depends on
          Write-Host "=== Copying codec libraries ==="
          $vcpkgLibDir = "$env:VCPKG_ROOT/installed/x64-windows-static/lib"
          $codecLibs = @(
            "libx264.lib",
            "x265-static.lib",
            "vpx.lib",
            "dav1d.lib",
            "opus.lib",
            "libmp3lame-static.lib",
            "libmpghip-static.lib",
            "vorbis.lib",
            "vorbisenc.lib",
            "vorbisfile.lib",
            "ogg.lib",
            "libwebp.lib",
            "libwebpdecoder.lib",
            "libwebpdemux.lib",
            "libwebpmux.lib",
            "libsharpyuv.lib",
            "jxl.lib",
            "jxl_threads.lib",
            "hwy.lib",
            "brotlidec.lib",
            "brotlienc.lib",
            "brotlicommon.lib",
            "lcms2.lib",
            "zlib.lib"
          )
          foreach ($lib in $codecLibs) {
            $srcPath = "$vcpkgLibDir/$lib"
            if (Test-Path $srcPath) {
              Copy-Item -Path $srcPath -Destination "$prefix/lib/" -Force
              Write-Host "  Copied: $lib"
            } else {
              Write-Host "  WARNING: $lib not found at $srcPath"
            }
          }

          # Copy vcpkg codec headers
          $vcpkgIncDir = "$env:VCPKG_ROOT/installed/x64-windows-static/include"
          $codecHeaders = @("x264.h", "x264_config.h", "x265.h", "x265_config.h", "vpx", "opus", "lame", "vorbis", "ogg", "webp", "jxl", "hwy", "brotli", "lcms2.h")
          foreach ($header in $codecHeaders) {
            $srcPath = "$vcpkgIncDir/$header"
            if (Test-Path $srcPath) {
              Copy-Item -Path $srcPath -Destination "$prefix/include/" -Recurse -Force
            }
          }

          Write-Host "=== Libraries ==="
          Get-ChildItem "$prefix/lib/"
          Write-Host "=== Headers ==="
          Get-ChildItem "$prefix/include/" -Recurse

      - name: Create archive
        run: |
          Compress-Archive -Path "ffmpeg-x86_64-pc-windows-msvc/*" -DestinationPath "ffmpeg-x86_64-pc-windows-msvc.zip"

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ffmpeg-x86_64-pc-windows-msvc.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-x86_64-pc-windows-msvc
          path: ffmpeg-x86_64-pc-windows-msvc.zip
          if-no-files-found: error

  # Build armv7 using native GCC cross-toolchain (zig has issues with nasm/assembly)
  build-ffmpeg-armv7:
    name: Build armv7-unknown-linux-gnueabihf
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: read
    container:
      image: debian:bullseye

    steps:
      - name: Setup tools
        run: |
          apt-get update
          apt-get install -y \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
            libc6-dev-armhf-cross libatomic1-armhf-cross \
            git build-essential cmake ninja-build \
            wget curl gnupg pkg-config \
            autoconf automake libtool \
            nasm yasm

      - uses: actions/checkout@v4

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.x'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-unknown-linux-gnueabihf

      - name: Config git
        run: git config --global --add safe.directory "$(pwd)"

      - name: Build FFmpeg
        run: |
          export CC=arm-linux-gnueabihf-gcc
          export CXX=arm-linux-gnueabihf-g++
          export AR=arm-linux-gnueabihf-ar
          export RANLIB=arm-linux-gnueabihf-ranlib
          # Use gcc as AS for .S files (needs preprocessing, raw 'as' can't handle -S flag)
          export AS=arm-linux-gnueabihf-gcc
          export STRIP=arm-linux-gnueabihf-strip
          # Enable NEON for armv7 hard-float
          export CFLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard"
          export CXXFLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard"
          cargo build --release -p build-ffmpeg
          ./target/release/build-ffmpeg \
            --target armv7-unknown-linux-gnueabihf \
            --output ./ffmpeg-armv7-unknown-linux-gnueabihf \
            --use-system-cc \
            --verbose

      - name: Create tarball
        run: |
          tar -czvf ffmpeg-armv7-unknown-linux-gnueabihf.tar.gz \
            -C ./ffmpeg-armv7-unknown-linux-gnueabihf .

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ffmpeg-armv7-unknown-linux-gnueabihf.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-armv7-unknown-linux-gnueabihf
          path: ffmpeg-armv7-unknown-linux-gnueabihf.tar.gz
          if-no-files-found: error

  # Build macOS x64 static libs (dav1d, libjxl + deps)
  # These are needed because Homebrew only provides dynamic .dylib files
  build-static-libs-macos-x64:
    name: Build static-libs x86_64-apple-darwin
    runs-on: macos-15-intel
    permissions:
      id-token: write
      attestations: write
      contents: read

    env:
      MACOSX_DEPLOYMENT_TARGET: '10.13'

    steps:
      - uses: actions/checkout@v4

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.x'

      - name: Install build dependencies
        run: |
          brew install meson ninja nasm llvm@20
          echo "$(brew --prefix llvm@20)/bin" >> $GITHUB_PATH

      - name: Build static libraries
        env:
          CC: clang
          CXX: clang++
        run: |
          set -ex
          PREFIX=$(pwd)/static-libs-x86_64-apple-darwin
          mkdir -p $PREFIX/{lib,include,lib/pkgconfig}
          export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig"
          export CFLAGS="-I$PREFIX/include -O2 -mmacosx-version-min=10.13"
          export CXXFLAGS="-I$PREFIX/include -O2 -mmacosx-version-min=10.13"
          export LDFLAGS="-L$PREFIX/lib"
          JOBS=$(sysctl -n hw.ncpu)

          # dav1d (AV1 decoder)
          git clone --depth 1 --branch 1.5.2 https://code.videolan.org/videolan/dav1d.git
          cd dav1d
          meson setup build --default-library=static --buildtype=release \
            -Denable_tools=false -Denable_tests=false --prefix=$PREFIX
          ninja -C build && ninja -C build install
          cd ..

          # highway (SIMD for libjxl)
          git clone --depth 1 --branch 1.3.0 https://github.com/google/highway.git
          cd highway
          cmake -B _build -DCMAKE_INSTALL_PREFIX=$PREFIX -DCMAKE_OSX_DEPLOYMENT_TARGET=10.13 \
            -DBUILD_SHARED_LIBS=OFF -DBUILD_TESTING=OFF \
            -DHWY_ENABLE_EXAMPLES=OFF -DHWY_ENABLE_TESTS=OFF
          cmake --build _build -j$JOBS
          cmake --install _build
          cd ..

          # brotli (compression for libjxl)
          git clone --depth 1 --branch v1.1.0 https://github.com/google/brotli.git
          cd brotli
          cmake -B _build -DCMAKE_INSTALL_PREFIX=$PREFIX -DCMAKE_OSX_DEPLOYMENT_TARGET=10.13 \
            -DBUILD_SHARED_LIBS=OFF -DBROTLI_DISABLE_TESTS=ON
          cmake --build _build -j$JOBS
          cmake --install _build
          cd ..

          # lcms2 (color management for libjxl) - uses autotools, not cmake
          git clone --depth 1 --branch lcms2.16 https://github.com/mm2/Little-CMS.git
          cd Little-CMS
          ./configure --prefix=$PREFIX --enable-static --disable-shared --with-pic
          make -j$JOBS
          make install
          cd ..

          # libjxl (JPEG XL)
          git clone --depth 1 --branch v0.11.1 --recurse-submodules --shallow-submodules https://github.com/libjxl/libjxl.git
          cd libjxl
          cmake -B _build -DCMAKE_INSTALL_PREFIX=$PREFIX -DCMAKE_OSX_DEPLOYMENT_TARGET=10.13 \
            -DBUILD_SHARED_LIBS=OFF -DBUILD_TESTING=OFF \
            -DJPEGXL_ENABLE_TOOLS=OFF -DJPEGXL_ENABLE_BENCHMARK=OFF \
            -DJPEGXL_ENABLE_EXAMPLES=OFF -DJPEGXL_ENABLE_MANPAGES=OFF \
            -DJPEGXL_ENABLE_DOXYGEN=OFF -DJPEGXL_ENABLE_JNI=OFF \
            -DJPEGXL_ENABLE_JPEGLI=OFF \
            -DJPEGXL_FORCE_SYSTEM_HWY=ON -DJPEGXL_FORCE_SYSTEM_BROTLI=ON \
            -DJPEGXL_FORCE_SYSTEM_LCMS2=ON
          cmake --build _build -j$JOBS
          cmake --install _build
          cd ..

      - name: Create tarball
        run: tar -czvf static-libs-x86_64-apple-darwin.tar.gz -C ./static-libs-x86_64-apple-darwin .

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: static-libs-x86_64-apple-darwin.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-libs-x86_64-apple-darwin
          path: static-libs-x86_64-apple-darwin.tar.gz
          if-no-files-found: error

  # Build macOS arm64 static libs (dav1d, libjxl + deps)
  build-static-libs-macos-arm64:
    name: Build static-libs aarch64-apple-darwin
    runs-on: macos-latest
    permissions:
      id-token: write
      attestations: write
      contents: read

    env:
      MACOSX_DEPLOYMENT_TARGET: '11.0'

    steps:
      - uses: actions/checkout@v4

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.x'

      - name: Install build dependencies
        run: |
          brew install meson ninja nasm llvm@20
          echo "$(brew --prefix llvm@20)/bin" >> $GITHUB_PATH

      - name: Build static libraries
        env:
          CC: clang
          CXX: clang++
        run: |
          set -ex
          PREFIX=$(pwd)/static-libs-aarch64-apple-darwin
          mkdir -p $PREFIX/{lib,include,lib/pkgconfig}
          export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig"
          export CFLAGS="-I$PREFIX/include -O2 -mmacosx-version-min=11.0"
          export CXXFLAGS="-I$PREFIX/include -O2 -mmacosx-version-min=11.0"
          export LDFLAGS="-L$PREFIX/lib"
          JOBS=$(sysctl -n hw.ncpu)

          # dav1d (AV1 decoder)
          git clone --depth 1 --branch 1.5.2 https://code.videolan.org/videolan/dav1d.git
          cd dav1d
          meson setup build --default-library=static --buildtype=release \
            -Denable_tools=false -Denable_tests=false --prefix=$PREFIX
          ninja -C build && ninja -C build install
          cd ..

          # highway (SIMD for libjxl)
          git clone --depth 1 --branch 1.3.0 https://github.com/google/highway.git
          cd highway
          cmake -B _build -DCMAKE_INSTALL_PREFIX=$PREFIX -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
            -DBUILD_SHARED_LIBS=OFF -DBUILD_TESTING=OFF \
            -DHWY_ENABLE_EXAMPLES=OFF -DHWY_ENABLE_TESTS=OFF
          cmake --build _build -j$JOBS
          cmake --install _build
          cd ..

          # brotli (compression for libjxl)
          git clone --depth 1 --branch v1.1.0 https://github.com/google/brotli.git
          cd brotli
          cmake -B _build -DCMAKE_INSTALL_PREFIX=$PREFIX -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
            -DBUILD_SHARED_LIBS=OFF -DBROTLI_DISABLE_TESTS=ON
          cmake --build _build -j$JOBS
          cmake --install _build
          cd ..

          # lcms2 (color management for libjxl) - uses autotools, not cmake
          git clone --depth 1 --branch lcms2.16 https://github.com/mm2/Little-CMS.git
          cd Little-CMS
          ./configure --prefix=$PREFIX --enable-static --disable-shared --with-pic
          make -j$JOBS
          make install
          cd ..

          # libjxl (JPEG XL)
          git clone --depth 1 --branch v0.11.1 --recurse-submodules --shallow-submodules https://github.com/libjxl/libjxl.git
          cd libjxl
          cmake -B _build -DCMAKE_INSTALL_PREFIX=$PREFIX -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
            -DBUILD_SHARED_LIBS=OFF -DBUILD_TESTING=OFF \
            -DJPEGXL_ENABLE_TOOLS=OFF -DJPEGXL_ENABLE_BENCHMARK=OFF \
            -DJPEGXL_ENABLE_EXAMPLES=OFF -DJPEGXL_ENABLE_MANPAGES=OFF \
            -DJPEGXL_ENABLE_DOXYGEN=OFF -DJPEGXL_ENABLE_JNI=OFF \
            -DJPEGXL_ENABLE_JPEGLI=OFF \
            -DJPEGXL_FORCE_SYSTEM_HWY=ON -DJPEGXL_FORCE_SYSTEM_BROTLI=ON \
            -DJPEGXL_FORCE_SYSTEM_LCMS2=ON
          cmake --build _build -j$JOBS
          cmake --install _build
          cd ..

      - name: Create tarball
        run: tar -czvf static-libs-aarch64-apple-darwin.tar.gz -C ./static-libs-aarch64-apple-darwin .

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: static-libs-aarch64-apple-darwin.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-libs-aarch64-apple-darwin
          path: static-libs-aarch64-apple-darwin.tar.gz
          if-no-files-found: error

  create-release:
    needs:
      - build-ffmpeg
      - build-ffmpeg-armv7
      - build-ffmpeg-windows-arm64
      - build-ffmpeg-windows-x64
      - build-static-libs-macos-x64
      - build-static-libs-macos-arm64
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -name '*.tar.gz' -exec mv {} release/ \;
          find artifacts -name '*.zip' -exec mv {} release/ \;
          ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ffmpeg-${{ env.FFMPEG_VERSION }}
          name: FFmpeg ${{ env.FFMPEG_VERSION }} Static Builds
          body: |
            Pre-built FFmpeg ${{ env.FFMPEG_VERSION }} static libraries.

            ## Included Libraries
            - FFmpeg: avcodec, avutil, swscale, swresample
            - Video: x264, x265, libvpx, libaom (Linux/arm64), rav1e (Windows x64)
            - Audio: opus, mp3lame, vorbis
            - Image: libwebp, libjxl

            ## Targets

            ### Linux
            - x86_64-unknown-linux-gnu
            - aarch64-unknown-linux-gnu
            - armv7-unknown-linux-gnueabihf
            - x86_64-unknown-linux-musl
            - aarch64-unknown-linux-musl

            ### Windows (MSVC)
            - x86_64-pc-windows-msvc (uses rav1e for AV1 encoding)
            - aarch64-pc-windows-msvc (uses libaom for AV1 encoding)

            ### macOS (Static Libs Only)
            - x86_64-apple-darwin (dav1d, libjxl + deps)
            - aarch64-apple-darwin (dav1d, libjxl + deps)

            Note: macOS builds use Homebrew FFmpeg. These archives contain only
            the static libraries (dav1d, libjxl, highway, brotli, lcms2) that
            Homebrew doesn't provide as static builds.

            ## Verification

            All artifacts are signed with [GitHub Artifact Attestations](https://docs.github.com/en/actions/security-guides/using-artifact-attestations-to-establish-provenance-for-builds).
            Verify with: `gh attestation verify <artifact> --repo ${{ github.repository }}`
          files: |
            release/*.tar.gz
            release/*.zip
          draft: false
          prerelease: false
