name: Build FFmpeg Static

on:
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version tag (e.g., n8.0.1)'
        required: true
        default: 'n8.0.1'
  push:
    branches:
      - prepare-release

env:
  FFMPEG_VERSION: ${{ github.event.inputs.ffmpeg_version || 'n8.0.1' }}

jobs:
  # Build for x86_64 and aarch64 targets using zig
  build-ffmpeg:
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-musl

    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Setup nasm
        uses: ilammy/setup-nasm@v1

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake git nasm yasm pkg-config \
            autoconf automake libtool curl

      - name: Build FFmpeg
        run: |
          cargo build --release -p build-ffmpeg
          ./target/release/build-ffmpeg \
            --target ${{ matrix.target }} \
            --output ./ffmpeg-${{ matrix.target }} \
            --verbose

      - name: Create tarball
        run: |
          tar -czvf ffmpeg-${{ matrix.target }}.tar.gz \
            -C ./ffmpeg-${{ matrix.target }} .

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ffmpeg-${{ matrix.target }}.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.target }}
          path: ffmpeg-${{ matrix.target }}.tar.gz
          if-no-files-found: error

  # Build Windows targets using vcpkg (pure MSVC, no MSYS2/MinGW)
  build-ffmpeg-windows:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            triplet: x64-windows-static
            arch: x64
          - target: aarch64-pc-windows-msvc
            triplet: arm64-windows-static
            arch: arm64

    name: Build ${{ matrix.target }}
    runs-on: windows-latest
    permissions:
      id-token: write
      attestations: write
      contents: read

    env:
      VCPKG_DEFAULT_TRIPLET: ${{ matrix.triplet }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '74e6536215718009aae747d86d84b78376bf9e09'

      - name: Install FFmpeg with codecs via vcpkg
        run: |
          vcpkg install ffmpeg[avcodec,swresample,swscale,gpl,x264,x265,vpx,aom,opus,mp3lame,vorbis,webp,zlib]:${{ matrix.triplet }}

      - name: List vcpkg installed libraries
        run: |
          Write-Host "=== All installed .lib files in vcpkg ==="
          Get-ChildItem "$env:VCPKG_ROOT/installed/${{ matrix.triplet }}/lib/*.lib" | ForEach-Object { $_.Name }

      - name: Prepare output directory
        run: |
          $prefix = "ffmpeg-${{ matrix.target }}"
          New-Item -ItemType Directory -Force -Path "$prefix/lib"
          New-Item -ItemType Directory -Force -Path "$prefix/include"

          # Copy libraries
          Copy-Item -Path "$env:VCPKG_ROOT/installed/${{ matrix.triplet }}/lib/*.lib" -Destination "$prefix/lib/" -Force

          # Copy headers
          Copy-Item -Path "$env:VCPKG_ROOT/installed/${{ matrix.triplet }}/include/libav*" -Destination "$prefix/include/" -Recurse -Force
          Copy-Item -Path "$env:VCPKG_ROOT/installed/${{ matrix.triplet }}/include/libsw*" -Destination "$prefix/include/" -Recurse -Force

          # Copy codec headers if present
          $codecHeaders = @("x264.h", "x264_config.h", "x265.h", "x265_config.h", "vpx", "aom", "opus", "lame", "vorbis", "ogg", "webp")
          foreach ($header in $codecHeaders) {
            $srcPath = "$env:VCPKG_ROOT/installed/${{ matrix.triplet }}/include/$header"
            if (Test-Path $srcPath) {
              Copy-Item -Path $srcPath -Destination "$prefix/include/" -Recurse -Force
            }
          }

          # List output
          Write-Host "=== Libraries ==="
          Get-ChildItem "$prefix/lib/"
          Write-Host "=== Headers ==="
          Get-ChildItem "$prefix/include/" -Recurse

      - name: Create archive
        run: |
          Compress-Archive -Path "ffmpeg-${{ matrix.target }}/*" -DestinationPath "ffmpeg-${{ matrix.target }}.zip"

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ffmpeg-${{ matrix.target }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.target }}
          path: ffmpeg-${{ matrix.target }}.zip
          if-no-files-found: error

  # Build armv7 using native GCC cross-toolchain (zig has issues with nasm/assembly)
  build-ffmpeg-armv7:
    name: Build armv7-unknown-linux-gnueabihf
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: read
    container:
      image: debian:bullseye

    steps:
      - name: Setup tools
        run: |
          apt-get update
          apt-get install -y \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
            libc6-dev-armhf-cross libatomic1-armhf-cross \
            git build-essential cmake ninja-build \
            wget curl gnupg pkg-config \
            autoconf automake libtool \
            nasm yasm

      - uses: actions/checkout@v4

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.x'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-unknown-linux-gnueabihf

      - name: Config git
        run: git config --global --add safe.directory "$(pwd)"

      - name: Build FFmpeg
        run: |
          export CC=arm-linux-gnueabihf-gcc
          export CXX=arm-linux-gnueabihf-g++
          export AR=arm-linux-gnueabihf-ar
          export RANLIB=arm-linux-gnueabihf-ranlib
          # Use gcc as AS for .S files (needs preprocessing, raw 'as' can't handle -S flag)
          export AS=arm-linux-gnueabihf-gcc
          export STRIP=arm-linux-gnueabihf-strip
          # Enable NEON for armv7 hard-float
          export CFLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard"
          export CXXFLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard"
          cargo build --release -p build-ffmpeg
          ./target/release/build-ffmpeg \
            --target armv7-unknown-linux-gnueabihf \
            --output ./ffmpeg-armv7-unknown-linux-gnueabihf \
            --use-system-cc \
            --verbose

      - name: Create tarball
        run: |
          tar -czvf ffmpeg-armv7-unknown-linux-gnueabihf.tar.gz \
            -C ./ffmpeg-armv7-unknown-linux-gnueabihf .

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ffmpeg-armv7-unknown-linux-gnueabihf.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-armv7-unknown-linux-gnueabihf
          path: ffmpeg-armv7-unknown-linux-gnueabihf.tar.gz
          if-no-files-found: error

  create-release:
    needs:
      - build-ffmpeg
      - build-ffmpeg-armv7
      - build-ffmpeg-windows
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -name '*.tar.gz' -exec mv {} release/ \;
          find artifacts -name '*.zip' -exec mv {} release/ \;
          ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ffmpeg-${{ env.FFMPEG_VERSION }}
          name: FFmpeg ${{ env.FFMPEG_VERSION }} Static Builds
          body: |
            Pre-built FFmpeg ${{ env.FFMPEG_VERSION }} static libraries.

            ## Included Libraries
            - FFmpeg: avcodec, avutil, swscale, swresample
            - Video: x264, x265, libvpx, libaom
            - Audio: opus, mp3lame, vorbis
            - Image: libwebp

            ## Targets

            ### Linux
            - x86_64-unknown-linux-gnu
            - aarch64-unknown-linux-gnu
            - armv7-unknown-linux-gnueabihf
            - x86_64-unknown-linux-musl
            - aarch64-unknown-linux-musl

            ### Windows (MSVC)
            - x86_64-pc-windows-msvc
            - aarch64-pc-windows-msvc

            ## Verification

            All artifacts are signed with [GitHub Artifact Attestations](https://docs.github.com/en/actions/security-guides/using-artifact-attestations-to-establish-provenance-for-builds).
            Verify with: `gh attestation verify <artifact> --repo ${{ github.repository }}`
          files: |
            release/*.tar.gz
            release/*.zip
          draft: false
          prerelease: false
